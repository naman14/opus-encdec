"use strict";var AudioContext=window.AudioContext||window.webkitAudioContext,getWorkerURL=function(e){const t=`importScripts("${e}");`;return URL.createObjectURL(new Blob([t],{type:"text/javascript"}))},Recorder=function(e={}){if(!Recorder.isRecordingSupported())throw new Error("Recording is not supported in this browser");this.state="inactive",this.config=Object.assign({bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderPath:"https://symbl-sdk-cdn-bucket.storage.googleapis.com/js/ga/symbl-opus-encdec/0.1.2/dist/encoderWorker.min.js",encoderSampleRate:48e3,maxFramesPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!1,wavBitDepth:16,sourceNode:{context:null}},e),this.encodedSamplePosition=0,this.initAudioContext(),this.encoderWorkerUrl=getWorkerURL(this.config.encoderPath),this.initialize=this.initWorklet().then(()=>this.initEncoder())};Recorder.isRecordingSupported=function(){const e=window.navigator&&window.navigator.mediaDevices&&window.navigator.mediaDevices.getUserMedia;return AudioContext&&e&&window.WebAssembly},Recorder.version="0.1.2",Recorder.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach(e=>e.stop()):this.stream.stop())},Recorder.prototype.close=function(){return this.monitorGainNode.disconnect(),this.recordingGainNode.disconnect(),this.sourceNode&&this.sourceNode.disconnect(),this.clearStream(),this.encoder&&(this.encoderNode.disconnect(),this.encoder.postMessage({command:"close"})),this.config.sourceNode.context?(URL.revokeObjectURL(this.encoderWorkerUrl),Promise.resolve()):this.audioContext.close()},Recorder.prototype.encodeBuffers=function(e){if("recording"===this.state){for(var t=[],o=0;o<e.numberOfChannels;o++)t[o]=e.getChannelData(o);this.encoder.postMessage({command:"encode",buffers:t})}},Recorder.prototype.initAudioContext=function(){this.audioContext=this.config.sourceNode.context?this.config.sourceNode.context:new AudioContext,this.monitorGainNode=this.audioContext.createGain(),this.setMonitorGain(this.config.monitorGain),this.recordingGainNode=this.audioContext.createGain(),this.setRecordingGain(this.config.recordingGain)},Recorder.prototype.initEncoder=function(){"function"==typeof registerProcessor?(this.encoderNode=new AudioWorkletNode(this.audioContext,"encoder-worklet",{numberOfOutputs:0}),this.encoder=this.encoderNode.port):(this.encoderNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.encoderNode.onaudioprocess=(({inputBuffer:e})=>this.encodeBuffers(e)),this.encoderNode.connect(this.audioContext.destination),this.encoder=new window.Worker(this.encoderWorkerUrl))},Recorder.prototype.initSourceNode=function(){return this.config.sourceNode.context?(this.sourceNode=this.config.sourceNode,Promise.resolve()):window.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then(e=>{this.stream=e,this.sourceNode=this.audioContext.createMediaStreamSource(e)})},Recorder.prototype.initWorker=function(){var e=(this.config.streamPages?this.streamPage:this.storePage).bind(this);return this.recordedPages=[],this.totalLength=0,new Promise(t=>{var o=({data:i})=>{switch(i.message){case"ready":t();break;case"page":this.encodedSamplePosition=i.samplePosition,e(i.page);break;case"done":this.encoder.removeEventListener("message",o),this.finish();break;default:i.page&&e(i.page)}};this.encoder.addEventListener("message",o),this.encoder.start&&this.encoder.start();const{sourceNode:i,...r}=this.config;this.encoder.postMessage(Object.assign({command:"init",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},r))})},Recorder.prototype.initWorklet=function(){return"function"==typeof registerProcessor?this.audioContext.audioWorklet.addModule(this.encoderWorkerUrl):Promise.resolve()},Recorder.prototype.pause=function(e){if("recording"===this.state)return this.state="paused",this.recordingGainNode.disconnect(),e&&this.config.streamPages?new Promise(e=>{var t=({data:o})=>{"flushed"===o.message&&(this.encoder.removeEventListener("message",t),this.onpause(),e())};this.encoder.addEventListener("message",t),this.encoder.start&&this.encoder.start(),this.encoder.postMessage({command:"flush"})}):(this.onpause(),Promise.resolve())},Recorder.prototype.resume=function(){"paused"===this.state&&(this.state="recording",this.recordingGainNode.connect(this.encoderNode),this.onresume())},Recorder.prototype.setRecordingGain=function(e){this.config.recordingGain=e,this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},Recorder.prototype.setMonitorGain=function(e){this.config.monitorGain=e,this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(e,this.audioContext.currentTime,.01)},Recorder.prototype.start=function(){return"inactive"===this.state?(this.state="loading",this.encodedSamplePosition=0,this.audioContext.resume().then(()=>this.initialize).then(()=>Promise.all([this.initSourceNode(),this.initWorker()])).then(()=>{this.state="recording",this.encoder.postMessage({command:"getHeaderPages"}),this.sourceNode.connect(this.monitorGainNode),this.sourceNode.connect(this.recordingGainNode),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode.connect(this.encoderNode),this.onstart()}).catch(e=>{throw console.log("Setting state to inactive"),this.state="inactive",e})):Promise.resolve()},Recorder.prototype.stop=function(){return"paused"===this.state||"recording"===this.state?(this.state="inactive",this.recordingGainNode.connect(this.encoderNode),this.monitorGainNode.disconnect(),this.clearStream(),new Promise(e=>{var t=({data:o})=>{"done"===o.message&&(this.encoder.removeEventListener("message",t),e())};this.encoder.addEventListener("message",t),this.encoder.start&&this.encoder.start(),this.encoder.postMessage({command:"done"})})):Promise.resolve()},Recorder.prototype.storePage=function(e){this.recordedPages.push(e),this.totalLength+=e.length},Recorder.prototype.streamPage=function(e){this.ondataavailable(e)},Recorder.prototype.finish=function(){if(!this.config.streamPages){var e=new Uint8Array(this.totalLength);this.recordedPages.reduce(function(t,o){return e.set(o,t),t+o.length},0),this.ondataavailable(e)}this.onstop()},Recorder.prototype.ondataavailable=function(){},Recorder.prototype.onpause=function(){},Recorder.prototype.onresume=function(){},Recorder.prototype.onstart=function(){},Recorder.prototype.onstop=function(){},"undefined"!=typeof exports?exports.Recorder=Recorder:"object"==typeof module&&module&&module.exports&&(module.exports.Recorder=Recorder);
